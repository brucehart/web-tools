<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Date Calculator</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #ffffff;
        --fg: #111111;
        --header-bg: #2f2f2f;
        --header-fg: #f3f3f3;
        --border: #cfcfcf;
        --pane-bg: #f6f6f6;
        --muted: #666666;
        --accent: #7aa2f7;
      }
      [data-theme="dark"] {
        --bg: #121212;
        --fg: #eaeaea;
        --header-bg: #2f2f2f;
        --header-fg: #f3f3f3;
        --border: #3a3a3a;
        --pane-bg: #1a1a1a;
        --muted: #9aa0a6;
        --accent: #7aa2f7;
      }
      * { box-sizing: border-box; }
      html, body { height: 100%; margin: 0; }
      body { background: var(--bg); color: var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, sans-serif; }
      header { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); background: var(--header-bg); color: var(--header-fg); position: sticky; top: 0; z-index: 10; }
      header h1 { margin: 0; font-size: 1.1rem; font-weight: 600; }
      header .actions { display: flex; gap: 8px; align-items: center; }
      .icon-btn { appearance: none; border: 1px solid var(--border); background: transparent; color: inherit; padding: 6px 10px; border-radius: 8px; font-size: 0.9rem; line-height: 1; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; }
      .icon-btn:hover { background: rgba(127,127,127,0.12); }
      main { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; }
      .panel { border: 1px solid var(--border); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; background: var(--pane-bg); }
      .panel header { border-bottom: 1px solid var(--border); padding: .6rem .8rem; font-weight: 600; }
      .panel .content { padding: .75rem; display: flex; gap: 10px; flex-direction: column; }
      .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      label { min-width: 120px; }
      input, select, button { font: inherit; padding: .5rem .6rem; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: inherit; }
      input[type="number"] { width: 8ch; }
      .grow { flex: 1; }
      .muted { color: var(--muted); font-size: .9rem; }
      .result { padding: .5rem .6rem; border: 1px dashed var(--border); border-radius: 8px; background: rgba(127,127,127,0.06); }
      .date-input { display: inline-flex; align-items: center; gap: 6px; }
      .date-input input[type="text"] { width: 14ch; }
      /* Hide native date inputs; we render a custom calendar */
      .date-input input[type="date"] { display: none; }
      .today-link { color: var(--accent); text-decoration: none; font-size: .9rem; }
      .today-link:hover { text-decoration: underline; }
      .invalid { border-color: #d93025 !important; box-shadow: 0 0 0 2px rgba(217,48,37,0.15) inset; }
      @media (max-width: 1000px) { main { grid-template-columns: 1fr; } }

      /* Custom date picker */
      .datepicker { position: absolute; z-index: 9999; background: var(--bg); color: var(--fg); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); width: 288px; overflow: hidden; }
      .datepicker .dp-header { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; border-bottom: 1px solid var(--border); font-weight: 600; gap: 6px; }
      .datepicker .dp-title { display: inline-flex; align-items: center; gap: 6px; }
      .datepicker .dp-nav { border: 1px solid var(--border); background: transparent; color: inherit; padding: 4px 8px; border-radius: 6px; cursor: pointer; }
      .datepicker .dp-nav:hover { background: rgba(127,127,127,0.1); }
      .datepicker .dp-month, .datepicker .dp-year { border: 1px solid var(--border); background: transparent; color: inherit; padding: 4px 6px; border-radius: 6px; font: inherit; height: 28px; }
      .datepicker .dp-year { width: 6.5ch; }
      .datepicker .dp-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; padding: 8px; }
      .datepicker .dp-dow { text-align: center; font-size: 0.8rem; color: var(--muted); padding: 4px 0; }
      .datepicker .dp-day { appearance: none; border: none; background: transparent; color: inherit; width: 36px; height: 32px; line-height: 32px; text-align: center; border-radius: 6px; cursor: pointer; }
      .datepicker .dp-day:hover { background: rgba(127,127,127,0.12); }
      .datepicker .dp-day.outside { color: var(--muted); }
      .datepicker .dp-day.today { outline: 1px dashed var(--border); }
      .datepicker .dp-day.selected { background: var(--accent); color: white; }
      .datepicker .dp-footer { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; border-top: 1px solid var(--border); }
      .datepicker .dp-link { color: var(--accent); background: transparent; border: none; padding: 4px 6px; cursor: pointer; font: inherit; }
      .datepicker .dp-link:hover { text-decoration: underline; }
    </style>
  </head>
  <body>
    <header>
      <h1>Date Calculator</h1>
      <div class="actions">
        <a href="/" class="icon-btn" title="Home" aria-label="Home">üè†</a>
        <button id="toggleTheme" class="icon-btn" title="Toggle theme">üåô</button>
      </div>
    </header>

    <main>
      <section class="panel">
        <header>Difference Between Dates</header>
        <div class="content">
          <div class="row">
            <label for="diffStartTxt">Start Date</label>
            <div class="date-input">
              <input id="diffStartTxt" type="text" placeholder="MM/DD/YYYY" autocomplete="off" />
              <input id="diffStartCal" type="date" />
              <a id="diffStartToday" href="#" class="today-link">Today</a>
            </div>
          </div>
          <div class="row">
            <label for="diffEndTxt">End Date</label>
            <div class="date-input">
              <input id="diffEndTxt" type="text" placeholder="MM/DD/YYYY" autocomplete="off" />
              <input id="diffEndCal" type="date" />
              <a id="diffEndToday" href="#" class="today-link">Today</a>
            </div>
          </div>
          <div class="result" id="diffResult">
            <div class="muted">Enter both dates to see the difference.</div>
          </div>
        </div>
      </section>

      <section class="panel">
        <header>Add or Subtract</header>
        <div class="content">
          <div class="row">
            <label for="baseTxt">Base Date</label>
            <div class="date-input">
              <input id="baseTxt" type="text" placeholder="MM/DD/YYYY" autocomplete="off" />
              <input id="baseCal" type="date" />
              <a id="baseToday" href="#" class="today-link">Today</a>
            </div>
          </div>
          <div class="row">
            <label for="amount">Amount</label>
            <input id="amount" type="number" step="1" value="1" />
            <select id="unit">
              <option value="days">Days</option>
              <option value="weeks">Weeks</option>
              <option value="months">Months</option>
              <option value="years">Years</option>
            </select>
            <select id="op">
              <option value="add">Add</option>
              <option value="sub">Subtract</option>
            </select>
          </div>
          <div class="result" id="calcResult">
            <div class="muted">Set base date and amount to see the result.</div>
          </div>
        </div>
      </section>
    </main>

    <script>
      (function() {
        const THEME_KEY = 'date_theme';
        const root = document.documentElement;
        function preferredTheme() {
          const saved = localStorage.getItem(THEME_KEY);
          if (saved === 'light' || saved === 'dark') return saved;
          return (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light';
        }
        function applyTheme(theme) {
          root.setAttribute('data-theme', theme);
          localStorage.setItem(THEME_KEY, theme);
          const btn = document.getElementById('toggleTheme');
          if (btn) btn.textContent = (theme === 'dark') ? '‚òÄÔ∏è' : 'üåô';
        }

        const ids = [
          'diffStartTxt','diffStartCal','diffStartToday',
          'diffEndTxt','diffEndCal','diffEndToday',
          'baseTxt','baseCal','baseToday',
          'amount','unit','op','diffResult','calcResult'
        ];
        const els = Object.fromEntries(ids.map(id => [id, document.getElementById(id)]));

        function pad2(n){ return String(n).padStart(2,'0'); }
        function toISODateUTC(y,m,d) { return new Date(Date.UTC(y, m-1, d)); }
        function fromISODateUTC(date){ return { y: date.getUTCFullYear(), m: date.getUTCMonth()+1, d: date.getUTCDate() }; }
        function toYMD(val){ const y = val.getUTCFullYear(); const m = pad2(val.getUTCMonth()+1); const d = pad2(val.getUTCDate()); return `${y}-${m}-${d}`; }
        function fmtMDY(date){ const {y,m,d} = fromISODateUTC(date); return `${pad2(m)}/${pad2(d)}/${y}`; }

        function parseMDY(text){
          if (!text) return null;
          const t = String(text).trim();
          const m = t.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{4})$/);
          if (!m) return null;
          const mm = Number(m[1]);
          const dd = Number(m[2]);
          const yy = Number(m[3]);
          if (yy < 100) return null; // require 4-digit years
          if (mm < 1 || mm > 12) return null;
          const maxd = daysInMonth(yy, mm);
          if (dd < 1 || dd > maxd) return null;
          return { y: yy, m: mm, d: dd };
        }

        function daysInMonth(y, m) { return new Date(Date.UTC(y, m, 0)).getUTCDate(); }

        function setInvalid(el, isInvalid){ if (!el) return; el.classList.toggle('invalid', !!isInvalid); }

        // Lightweight custom date picker (UTC-based)
        function buildDatePicker(){
          const dp = document.createElement('div');
          dp.className = 'datepicker';
          dp.style.display = 'none';
          dp.innerHTML = `
            <div class="dp-header">
              <button type="button" class="dp-nav dp-prev" aria-label="Previous Month">‚ñ≤</button>
              <div class="dp-title"><select class="dp-month"></select><input class="dp-year" type="number" min="1" max="9999" inputmode="numeric" /></div>
              <button type="button" class="dp-nav dp-next" aria-label="Next Month">‚ñº</button>
            </div>
            <div class="dp-grid"></div>
            <div class="dp-footer">
              <button type="button" class="dp-link dp-clear">Clear</button>
              <button type="button" class="dp-link dp-today">Today</button>
            </div>`;
          document.body.appendChild(dp);

          const titleEl = dp.querySelector('.dp-title');
          const gridEl = dp.querySelector('.dp-grid');
          const prevBtn = dp.querySelector('.dp-prev');
          const nextBtn = dp.querySelector('.dp-next');
          const monthSel = dp.querySelector('.dp-month');
          const yearInput = dp.querySelector('.dp-year');
          const clearBtn = dp.querySelector('.dp-clear');
          const todayBtn = dp.querySelector('.dp-today');

          const state = { visible: false, anchor: null, viewY: 0, viewM: 0, selected: null, onPick: null };

          function monthLabel(y,m){
            return new Date(Date.UTC(y, m-1, 1)).toLocaleString(undefined, { month: 'long', year: 'numeric', timeZone: 'UTC' });
          }
          const monthNames = Array.from({length:12}, (_,i) => new Date(Date.UTC(2000, i, 1)).toLocaleString(undefined, { month: 'long', timeZone: 'UTC' }));
          if (monthSel) monthSel.innerHTML = monthNames.map((n, i) => `<option value="${i+1}">${n}</option>`).join('');
          function clampYear(y){ return Math.min(9999, Math.max(1, (y|0))); }
          function sameUTC(a,b){ return a && b && a.getUTCFullYear()===b.getUTCFullYear() && a.getUTCMonth()===b.getUTCMonth() && a.getUTCDate()===b.getUTCDate(); }

          function addMonths(y,m,delta){ // m: 1-12
            const nm = m-1 + delta;
            const ny = y + Math.floor(nm/12);
            const mo = ((nm%12)+12)%12 + 1; // back to 1-12
            return { y: ny, m: mo };
          }

          function render(){
            if (!gridEl || !titleEl) return;
            // Update dropdowns instead of overwriting title content
            if (monthSel) monthSel.value = String(state.viewM);
            if (yearInput) yearInput.value = String(state.viewY);
            gridEl.innerHTML = '';
            const dows = ['Su','Mo','Tu','We','Th','Fr','Sa'];
            for (let i=0;i<7;i++){ const el = document.createElement('div'); el.className='dp-dow'; el.textContent=dows[i]; gridEl.appendChild(el);}            
            const first = new Date(Date.UTC(state.viewY, state.viewM-1, 1));
            const start = new Date(Date.UTC(state.viewY, state.viewM-1, 1 - first.getUTCDay()));
            const today = new Date(); const todayUTC = toISODateUTC(today.getUTCFullYear(), today.getUTCMonth()+1, today.getUTCDate());
            for (let i=0;i<42;i++){
              const cur = new Date(start.getTime() + i*86400000);
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'dp-day';
              if ((cur.getUTCMonth()+1) !== state.viewM) btn.classList.add('outside');
              if (sameUTC(cur, todayUTC)) btn.classList.add('today');
              if (state.selected && sameUTC(cur, state.selected)) btn.classList.add('selected');
              btn.textContent = String(cur.getUTCDate());
              btn.addEventListener('click', () => pick(new Date(cur.getTime())));
              gridEl.appendChild(btn);
            }
          }

          function position(){
            if (!state.anchor) return;
            const r = state.anchor.getBoundingClientRect();
            const top = window.scrollY + r.bottom + 4;
            let left = window.scrollX + r.left;
            const width = 288; // matches CSS
            if (left + width > window.scrollX + window.innerWidth - 8) {
              left = window.scrollX + Math.max(8, window.innerWidth - width - 8);
            }
            dp.style.top = top + 'px';
            dp.style.left = left + 'px';
          }

          function open(anchor, initial, onPick){
            state.anchor = anchor;
            state.onPick = onPick;
            state.selected = initial || null;
            const base = state.selected || (function(){ const n=new Date(); return toISODateUTC(n.getUTCFullYear(), n.getUTCMonth()+1, n.getUTCDate());})();
            state.viewY = base.getUTCFullYear();
            state.viewM = base.getUTCMonth()+1;
            render();
            position();
            dp.style.display = 'block';
            state.visible = true;
            setTimeout(() => { document.addEventListener('mousedown', onDocDown, true); window.addEventListener('resize', position); window.addEventListener('scroll', position, true); }, 0);
          }

          function close(){
            if (!state.visible) return;
            state.visible = false;
            dp.style.display = 'none';
            document.removeEventListener('mousedown', onDocDown, true);
            window.removeEventListener('resize', position);
            window.removeEventListener('scroll', position, true);
          }

          function onDocDown(e){
            if (!state.visible) return;
            const t = e.target;
            if (dp.contains(t) || (state.anchor && state.anchor.contains(t))) return;
            close();
          }

          function pick(date){ if (state.onPick) state.onPick(date); close(); }

          prevBtn.addEventListener('click', () => { const nm = addMonths(state.viewY, state.viewM, -1); state.viewY = nm.y; state.viewM = nm.m; render(); position(); });
          nextBtn.addEventListener('click', () => { const nm = addMonths(state.viewY, state.viewM, +1); state.viewY = nm.y; state.viewM = nm.m; render(); position(); });
          if (monthSel) monthSel.addEventListener('change', () => { const v = parseInt(monthSel.value, 10); if (v>=1 && v<=12){ state.viewM = v; render(); position(); }});
          if (yearInput) yearInput.addEventListener('change', () => { const v = clampYear(parseInt(yearInput.value, 10) || state.viewY); state.viewY = v; render(); position(); });
          clearBtn.addEventListener('click', () => { pick(null); });
          todayBtn.addEventListener('click', () => { const n = new Date(); const d = toISODateUTC(n.getUTCFullYear(), n.getUTCMonth()+1, n.getUTCDate()); pick(d); });

          return { open, close };
        }

        const datePicker = buildDatePicker();

        function syncPair(textEl, calEl, todayEl) {
          function setBoth(date) {
            calEl.value = toYMD(date);
            textEl.value = fmtMDY(date);
            setInvalid(textEl, false);
            setInvalid(calEl, false);
          }
          textEl.addEventListener('input', () => {
            const p = parseMDY(textEl.value);
            if (!p) { setInvalid(textEl, textEl.value.trim().length > 0); return; }
            const d = toISODateUTC(p.y, p.m, p.d);
            setBoth(d);
            onChange();
          });
          function openPicker(){
            const existing = dateFromInputs(textEl, calEl);
            datePicker.open(textEl, existing, (picked) => {
              if (picked) setBoth(picked); else { textEl.value=''; calEl.value=''; }
              onChange();
            });
          }
          textEl.addEventListener('focus', openPicker);
          textEl.addEventListener('click', openPicker);
          calEl.addEventListener('change', () => {
            const v = calEl.value;
            if (!/^\d{4}-\d{2}-\d{2}$/.test(v)) { setInvalid(calEl, true); return; }
            const [y,m,d] = v.split('-').map(Number);
            const date = toISODateUTC(y,m,d);
            setBoth(date);
            onChange();
          });
          todayEl.addEventListener('click', (e) => {
            e.preventDefault();
            const now = new Date();
            const date = toISODateUTC(now.getUTCFullYear(), now.getUTCMonth()+1, now.getUTCDate());
            setBoth(date);
            onChange();
          });
          return { setBoth };
        }

        function dateFromInputs(txtEl, calEl) {
          const p = parseMDY(txtEl.value);
          if (p) return toISODateUTC(p.y, p.m, p.d);
          if (/^\d{4}-\d{2}-\d{2}$/.test(calEl.value)) {
            const [y,m,d] = calEl.value.split('-').map(Number);
            return toISODateUTC(y,m,d);
          }
          return null;
        }

        function diffAbsDays(a,b) {
          const ms = Math.abs(a.getTime() - b.getTime());
          return Math.round(ms / 86400000);
        }

        function calendarDiff(a, b) {
          // Ensure a <= b
          let start = a, end = b, sign = 1;
          if (a.getTime() > b.getTime()) { start = b; end = a; sign = -1; }
          const sa = fromISODateUTC(start);
          const ea = fromISODateUTC(end);
          let years = ea.y - sa.y;
          let months = ea.m - sa.m;
          let days = ea.d - sa.d;
          if (days < 0) {
            months -= 1;
            const prevMonth = ea.m - 1 <= 0 ? 12 : (ea.m - 1);
            const prevYear = prevMonth === 12 ? ea.y - 1 : ea.y;
            days += daysInMonth(prevYear, prevMonth);
          }
          if (months < 0) { months += 12; years -= 1; }
          return { years: years * sign, months: months * sign, days: days * sign };
        }

        function monthsBetween(start, end) {
          // Whole calendar months difference, negative if end < start
          const s = fromISODateUTC(start); const e = fromISODateUTC(end);
          let months = (e.y - s.y) * 12 + (e.m - s.m);
          // Adjust if end's day is before start's day
          if (e.d < s.d) months -= 1;
          return months;
        }

        function addCalendar(date, amount, unit) {
          const {y,m,d} = fromISODateUTC(date);
          if (unit === 'days') {
            return new Date(Date.UTC(y, m-1, d + amount));
          } else if (unit === 'weeks') {
            return new Date(Date.UTC(y, m-1, d + amount * 7));
          } else if (unit === 'months') {
            const nm = m - 1 + amount;
            const ny = y + Math.floor(nm / 12);
            const mo = ((nm % 12) + 12) % 12; // 0-11
            const maxd = daysInMonth(ny, mo+1);
            const nd = Math.min(d, maxd);
            return new Date(Date.UTC(ny, mo, nd));
          } else if (unit === 'years') {
            const ny = y + amount;
            const maxd = daysInMonth(ny, m);
            const nd = Math.min(d, maxd);
            return new Date(Date.UTC(ny, m-1, nd));
          }
          return date;
        }

        function numberFmt(n) { return n.toLocaleString(); }

        function renderDiff() {
          const out = els.diffResult;
          const a = dateFromInputs(els.diffStartTxt, els.diffStartCal);
          const b = dateFromInputs(els.diffEndTxt, els.diffEndCal);
          if (!a || !b) { out.innerHTML = '<div class="muted">Enter both dates to see the difference.</div>'; return; }
          const days = diffAbsDays(a,b);
          const weeks = Math.floor(days / 7);
          const remDays = days % 7;
          const cal = calendarDiff(a,b);
          const totalMonths = Math.abs(monthsBetween(a,b));
          const yearsFloat = (Math.abs(cal.years) + cal.months/12 + cal.days/365.2425) * (cal.years < 0 ? -1 : 1);
          out.innerHTML = `
            <div><strong>Calendar:</strong> ${Math.abs(cal.years)} year(s), ${Math.abs(cal.months)} month(s), ${Math.abs(cal.days)} day(s)</div>
            <div><strong>Total days:</strong> ${numberFmt(days)}</div>
            <div><strong>Weeks:</strong> ${numberFmt(weeks)} week(s) and ${numberFmt(remDays)} day(s)</div>
            <div><strong>Total months:</strong> ${numberFmt(totalMonths)}</div>
          `;
        }

        function renderCalc() {
          const out = els.calcResult;
          const base = dateFromInputs(els.baseTxt, els.baseCal);
          const amt = Number(els.amount.value || '0');
          const unit = els.unit.value;
          const op = els.op.value;
          if (!base) { out.innerHTML = '<div class="muted">Set base date and amount to see the result.</div>'; return; }
          if (!Number.isFinite(amt)) { out.textContent = 'Amount must be a number.'; return; }
          const signed = (op === 'sub') ? -amt : amt;
          const result = addCalendar(base, signed, unit);
          const deltaDays = diffAbsDays(base, result);
          const cal = calendarDiff(base, result);
          out.innerHTML = `
            <div><strong>Result date:</strong> ${fmtMDY(result)} (<code>${toYMD(result)}</code>)</div>
            <div><strong>Change (calendar):</strong> ${Math.abs(cal.years)} year(s), ${Math.abs(cal.months)} month(s), ${Math.abs(cal.days)} day(s)</div>
            <div><strong>Total days moved:</strong> ${numberFmt(deltaDays)}</div>
          `;
        }

        function onChange(){ renderDiff(); renderCalc(); }

        // Wire pairs and seed defaults
        const diffStart = syncPair(els.diffStartTxt, els.diffStartCal, els.diffStartToday);
        const diffEnd = syncPair(els.diffEndTxt, els.diffEndCal, els.diffEndToday);
        const basePair = syncPair(els.baseTxt, els.baseCal, els.baseToday);

        // Default both diff dates to today; base to today
        const now = new Date();
        const todayUTC = toISODateUTC(now.getUTCFullYear(), now.getUTCMonth()+1, now.getUTCDate());
        diffStart.setBoth(todayUTC);
        diffEnd.setBoth(todayUTC);
        basePair.setBoth(todayUTC);

        ['amount','unit','op'].forEach(id => { const e = els[id]; if (e) e.addEventListener('input', onChange); if (e) e.addEventListener('change', onChange); });

        applyTheme(preferredTheme());
        const toggleBtn = document.getElementById('toggleTheme');
        if (toggleBtn) {
          toggleBtn.addEventListener('click', () => {
            const current = root.getAttribute('data-theme') || preferredTheme();
            applyTheme(current === 'dark' ? 'light' : 'dark');
          });
        }

        onChange();
      })();
    </script>
  </body>
  </html>
