<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Date Calculator</title>
    <link rel="stylesheet" href="/shared/toolkit.css" />
    <script defer src="/shared/toolkit.js"></script>
    <style>
      :root {
        /* Map legacy vars onto the shared toolkit tokens */
        --bg-body: var(--bg);
        --bg-card: var(--panel);
        --fg-primary: var(--fg);
        --fg-secondary: var(--muted);
        --input-bg: var(--input-bg);
        --shadow: var(--shadow-sm);
        --radius: 16px;
        --header-bg: var(--header-bg);
      }

      * { box-sizing: border-box; }
      
      body {
        margin: 0;
        font-family: inherit;
        background: transparent;
        color: var(--fg-primary);
        line-height: 1.5;
        transition: background-color 0.3s ease, color 0.3s ease;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* Header */
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 2rem;
        background: var(--header-bg);
        border-bottom: 1px solid var(--border);
        position: sticky;
        top: 0;
        z-index: 20;
        box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      }

      header h1 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--fg-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      header .actions {
        display: flex;
        gap: 0.75rem;
      }

      .icon-btn {
        appearance: none;
        border: 1px solid var(--border);
        background: var(--bg-card);
        color: var(--fg-secondary);
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 1.1rem;
        text-decoration: none;
      }

      .icon-btn:hover {
        border-color: var(--accent);
        color: var(--accent);
        background: var(--input-bg);
      }

      /* Main Layout */
      main {
        flex: 1;
        max-width: 1000px;
        margin: 0 auto;
        width: 100%;
        padding: 2rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 2rem;
        align-items: start;
      }

      /* Cards */
      .card {
        background: var(--bg-card);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        overflow: hidden;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      
      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.05), 0 4px 6px -4px rgb(0 0 0 / 0.05);
      }

      .card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--border);
        font-weight: 600;
        font-size: 1.1rem;
        color: var(--fg-primary);
        background: linear-gradient(to right, var(--bg-card), var(--input-bg));
      }

      .card-content {
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      /* Form Elements */
      .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      label {
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--fg-secondary);
        text-transform: uppercase;
        letter-spacing: 0.025em;
      }

      .input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
      }

      input[type="text"],
      input[type="number"],
      select {
        width: 100%;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--input-bg);
        color: var(--fg-primary);
        font-family: inherit;
        font-size: 0.95rem;
        transition: all 0.2s;
        appearance: none;
      }

      input[type="text"]:focus,
      input[type="number"]:focus,
      select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px hsla(217, 91%, 60%, 0.15);
      }

      .input-icon {
        position: absolute;
        right: 1rem;
        color: var(--fg-secondary);
        pointer-events: none;
      }

      .row {
        display: flex;
        gap: 1rem;
      }
      
      .grow { flex: 1; }

      /* Custom Select Arrow */
      select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
      }

      /* Results */
      .result-box {
        background: var(--input-bg);
        border-radius: 8px;
        padding: 1.25rem;
        border: 1px solid var(--border);
      }

      .result-empty {
        color: var(--fg-secondary);
        font-size: 0.9rem;
        text-align: center;
        font-style: italic;
      }

      .result-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border);
      }
      
      .result-item:last-child { border-bottom: none; }

      .result-label {
        font-size: 0.9rem;
        color: var(--fg-secondary);
      }

      .result-value {
        font-weight: 600;
        color: var(--fg-primary);
        text-align: right;
      }
      
      .result-highlight {
        font-size: 1.1rem;
        color: var(--accent);
      }

      /* Utilities */
      .today-btn {
        font-size: 0.8rem;
        color: var(--accent);
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 0.25rem 0.5rem;
        margin-left: auto;
        font-weight: 500;
      }
      
      .today-btn:hover { text-decoration: underline; }

      .invalid {
        border-color: #ef4444 !important;
        background-color: #fef2f2 !important;
      }
      [data-theme="dark"] .invalid {
        background-color: #450a0a !important;
      }

      /* Date Picker */
      .datepicker {
        position: absolute;
        z-index: 100;
        background: var(--bg-card);
        color: var(--fg-primary);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.05);
        width: 300px;
        padding: 1rem;
        display: none;
        animation: fadeIn 0.2s ease-out;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .dp-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .dp-nav {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--fg-secondary);
        width: 32px;
        height: 32px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .dp-nav:hover {
        background: var(--input-bg);
        color: var(--fg-primary);
      }

      .dp-title {
        display: flex;
        gap: 0.5rem;
        font-weight: 600;
      }

      .dp-month-sel, .dp-year-input {
        border: none;
        background: transparent;
        color: var(--fg-primary);
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        padding: 0;
      }
      
      .dp-year-input { width: 60px; text-align: center; }

      .dp-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
        margin-bottom: 1rem;
      }

      .dp-dow {
        text-align: center;
        font-size: 0.75rem;
        color: var(--fg-secondary);
        font-weight: 500;
        padding-bottom: 0.5rem;
      }

      .dp-day {
        width: 100%;
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        background: transparent;
        color: var(--fg-primary);
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.1s;
      }

      .dp-day:hover {
        background: var(--input-bg);
      }

      .dp-day.outside {
        color: var(--fg-secondary);
        opacity: 0.5;
      }

      .dp-day.today {
        border: 1px solid var(--accent);
        color: var(--accent);
        font-weight: 600;
      }

      .dp-day.selected {
        background: var(--accent);
        color: white;
      }

      .dp-footer {
        display: flex;
        justify-content: space-between;
        border-top: 1px solid var(--border);
        padding-top: 0.75rem;
      }

      .dp-link {
        background: transparent;
        border: none;
        color: var(--accent);
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
      }
      
      .dp-link:hover { text-decoration: underline; }

      @media (max-width: 768px) {
        main { padding: 1rem; }
        header { padding: 0.75rem 1rem; }
      }
    </style>
  </head>
  <body class="wt" data-wt-tool="date" data-wt-title="Date Calculator">
    <div class="wt-header" role="banner"></div>

    <main class="wt-page">
      <!-- Difference Section -->
      <section class="card">
        <div class="card-header">Date Difference</div>
        <div class="card-content">
          <div class="form-group">
            <div style="display:flex; justify-content:space-between; align-items:baseline;">
              <label for="diffStartTxt">Start Date</label>
              <button id="diffStartToday" class="today-btn">Set to Today</button>
            </div>
            <div class="input-wrapper">
              <input id="diffStartTxt" type="text" placeholder="MM/DD/YYYY" autocomplete="off" />
              <input id="diffStartCal" type="date" style="display:none" /> <!-- Hidden native picker -->
              <div class="input-icon">ðŸ“…</div>
            </div>
          </div>

          <div class="form-group">
            <div style="display:flex; justify-content:space-between; align-items:baseline;">
              <label for="diffEndTxt">End Date</label>
              <button id="diffEndToday" class="today-btn">Set to Today</button>
            </div>
            <div class="input-wrapper">
              <input id="diffEndTxt" type="text" placeholder="MM/DD/YYYY" autocomplete="off" />
              <input id="diffEndCal" type="date" style="display:none" />
              <div class="input-icon">ðŸ“…</div>
            </div>
          </div>

          <div class="result-box" id="diffResult">
            <div class="result-empty">Enter both dates to see the difference.</div>
          </div>
        </div>
      </section>

      <!-- Calculator Section -->
      <section class="card">
        <div class="card-header">Add or Subtract</div>
        <div class="card-content">
          <div class="form-group">
            <div style="display:flex; justify-content:space-between; align-items:baseline;">
              <label for="baseTxt">Base Date</label>
              <button id="baseToday" class="today-btn">Set to Today</button>
            </div>
            <div class="input-wrapper">
              <input id="baseTxt" type="text" placeholder="MM/DD/YYYY" autocomplete="off" />
              <input id="baseCal" type="date" style="display:none" />
              <div class="input-icon">ðŸ“…</div>
            </div>
          </div>

          <div class="row">
            <div class="form-group grow">
              <label for="op">Operation</label>
              <select id="op">
                <option value="add">Add (+)</option>
                <option value="sub">Subtract (-)</option>
              </select>
            </div>
            <div class="form-group grow">
              <label for="amount">Amount</label>
              <input id="amount" type="number" step="1" value="1" min="0" />
            </div>
          </div>

          <div class="form-group">
            <label for="unit">Unit</label>
            <select id="unit">
              <option value="days">Days</option>
              <option value="weeks">Weeks</option>
              <option value="months">Months</option>
              <option value="years">Years</option>
            </select>
          </div>

          <div class="result-box" id="calcResult">
            <div class="result-empty">Set base date and amount to see the result.</div>
          </div>
        </div>
      </section>
    </main>

	    <script>
	      (function() {
	        const root = document.documentElement;
	        // Theme is owned by `public/shared/toolkit.js`.

        // Element References
        const ids = [
          'diffStartTxt','diffStartCal','diffStartToday',
          'diffEndTxt','diffEndCal','diffEndToday',
          'baseTxt','baseCal','baseToday',
          'amount','unit','op','diffResult','calcResult'
        ];
        const els = Object.fromEntries(ids.map(id => [id, document.getElementById(id)]));

        // Date Utils
        function pad2(n){ return String(n).padStart(2,'0'); }
        function toISODateUTC(y,m,d) { return new Date(Date.UTC(y, m-1, d)); }
        function fromISODateUTC(date){ return { y: date.getUTCFullYear(), m: date.getUTCMonth()+1, d: date.getUTCDate() }; }
        function toYMD(val){ const y = val.getUTCFullYear(); const m = pad2(val.getUTCMonth()+1); const d = pad2(val.getUTCDate()); return `${y}-${m}-${d}`; }
        function fmtMDY(date){ const {y,m,d} = fromISODateUTC(date); return `${pad2(m)}/${pad2(d)}/${y}`; }

        function parseMDY(text){
          if (!text) return null;
          const t = String(text).trim();
          const m = t.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{4})$/);
          if (!m) return null;
          const mm = Number(m[1]);
          const dd = Number(m[2]);
          const yy = Number(m[3]);
          if (yy < 100) return null; 
          if (mm < 1 || mm > 12) return null;
          const maxd = daysInMonth(yy, mm);
          if (dd < 1 || dd > maxd) return null;
          return { y: yy, m: mm, d: dd };
        }

        function daysInMonth(y, m) { return new Date(Date.UTC(y, m, 0)).getUTCDate(); }

        function setInvalid(el, isInvalid){ if (!el) return; el.classList.toggle('invalid', !!isInvalid); }

        // Custom Date Picker
        function buildDatePicker(){
          const dp = document.createElement('div');
          dp.className = 'datepicker';
          dp.innerHTML = `
            <div class="dp-header">
              <button type="button" class="dp-nav dp-prev" aria-label="Previous Month">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
              </button>
              <div class="dp-title">
                <select class="dp-month-sel"></select>
                <input class="dp-year-input" type="number" min="1" max="9999" />
              </div>
              <button type="button" class="dp-nav dp-next" aria-label="Next Month">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
              </button>
            </div>
            <div class="dp-grid"></div>
            <div class="dp-footer">
              <button type="button" class="dp-link dp-clear">Clear</button>
              <button type="button" class="dp-link dp-today">Today</button>
            </div>`;
          document.body.appendChild(dp);

          const gridEl = dp.querySelector('.dp-grid');
          const prevBtn = dp.querySelector('.dp-prev');
          const nextBtn = dp.querySelector('.dp-next');
          const monthSel = dp.querySelector('.dp-month-sel');
          const yearInput = dp.querySelector('.dp-year-input');
          const clearBtn = dp.querySelector('.dp-clear');
          const todayBtn = dp.querySelector('.dp-today');

          const state = { visible: false, anchor: null, viewY: 0, viewM: 0, selected: null, onPick: null };

          const monthNames = Array.from({length:12}, (_,i) => new Date(Date.UTC(2000, i, 1)).toLocaleString(undefined, { month: 'long', timeZone: 'UTC' }));
          if (monthSel) monthSel.innerHTML = monthNames.map((n, i) => `<option value="${i+1}">${n}</option>`).join('');

          function clampYear(y){ return Math.min(9999, Math.max(1, (y|0))); }
          function sameUTC(a,b){ return a && b && a.getUTCFullYear()===b.getUTCFullYear() && a.getUTCMonth()===b.getUTCMonth() && a.getUTCDate()===b.getUTCDate(); }
          function addMonths(y,m,delta){ 
            const nm = m-1 + delta;
            const ny = y + Math.floor(nm/12);
            const mo = ((nm%12)+12)%12 + 1; 
            return { y: ny, m: mo };
          }

          function render(){
            if (!gridEl) return;
            if (monthSel) monthSel.value = String(state.viewM);
            if (yearInput) yearInput.value = String(state.viewY);
            gridEl.innerHTML = '';
            const dows = ['Su','Mo','Tu','We','Th','Fr','Sa'];
            for (let i=0;i<7;i++){ const el = document.createElement('div'); el.className='dp-dow'; el.textContent=dows[i]; gridEl.appendChild(el);}            
            const first = new Date(Date.UTC(state.viewY, state.viewM-1, 1));
            const start = new Date(Date.UTC(state.viewY, state.viewM-1, 1 - first.getUTCDay()));
            const today = new Date(); const todayUTC = toISODateUTC(today.getUTCFullYear(), today.getUTCMonth()+1, today.getUTCDate());
            
            for (let i=0;i<42;i++){
              const cur = new Date(start.getTime() + i*86400000);
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'dp-day';
              if ((cur.getUTCMonth()+1) !== state.viewM) btn.classList.add('outside');
              if (sameUTC(cur, todayUTC)) btn.classList.add('today');
              if (state.selected && sameUTC(cur, state.selected)) btn.classList.add('selected');
              btn.textContent = String(cur.getUTCDate());
              btn.addEventListener('click', (e) => { e.stopPropagation(); pick(new Date(cur.getTime())); });
              gridEl.appendChild(btn);
            }
          }

          function position(){
            if (!state.anchor) return;
            const r = state.anchor.getBoundingClientRect();
            const top = window.scrollY + r.bottom + 8;
            let left = window.scrollX + r.left;
            const width = 300; 
            if (left + width > window.scrollX + window.innerWidth - 16) {
              left = window.scrollX + Math.max(16, window.innerWidth - width - 16);
            }
            dp.style.top = top + 'px';
            dp.style.left = left + 'px';
          }

          function open(anchor, initial, onPick){
            if (state.visible && state.anchor === anchor) return; // already open
            state.anchor = anchor;
            state.onPick = onPick;
            state.selected = initial || null;
            const base = state.selected || (function(){ const n=new Date(); return toISODateUTC(n.getUTCFullYear(), n.getUTCMonth()+1, n.getUTCDate());})();
            state.viewY = base.getUTCFullYear();
            state.viewM = base.getUTCMonth()+1;
            render();
            position();
            dp.style.display = 'block';
            state.visible = true;
            // Delay listener to avoid immediate close from the click that opened it
            setTimeout(() => { 
              document.addEventListener('mousedown', onDocDown, true); 
              window.addEventListener('resize', position); 
              window.addEventListener('scroll', position, true); 
            }, 50);
          }

          function close(){
            if (!state.visible) return;
            state.visible = false;
            dp.style.display = 'none';
            document.removeEventListener('mousedown', onDocDown, true);
            window.removeEventListener('resize', position);
            window.removeEventListener('scroll', position, true);
          }

          function onDocDown(e){
            if (!state.visible) return;
            const t = e.target;
            if (dp.contains(t) || (state.anchor && state.anchor.contains(t))) return;
            close();
          }

          function pick(date){ if (state.onPick) state.onPick(date); close(); }

          prevBtn.addEventListener('click', (e) => { e.stopPropagation(); const nm = addMonths(state.viewY, state.viewM, -1); state.viewY = nm.y; state.viewM = nm.m; render(); });
          nextBtn.addEventListener('click', (e) => { e.stopPropagation(); const nm = addMonths(state.viewY, state.viewM, +1); state.viewY = nm.y; state.viewM = nm.m; render(); });
          if (monthSel) monthSel.addEventListener('change', (e) => { e.stopPropagation(); const v = parseInt(monthSel.value, 10); if (v>=1 && v<=12){ state.viewM = v; render(); }});
          if (yearInput) yearInput.addEventListener('change', (e) => { e.stopPropagation(); const v = clampYear(parseInt(yearInput.value, 10) || state.viewY); state.viewY = v; render(); });
          yearInput.addEventListener('click', (e) => e.stopPropagation());
          monthSel.addEventListener('click', (e) => e.stopPropagation());
          
          clearBtn.addEventListener('click', (e) => { e.stopPropagation(); pick(null); });
          todayBtn.addEventListener('click', (e) => { e.stopPropagation(); const n = new Date(); const d = toISODateUTC(n.getUTCFullYear(), n.getUTCMonth()+1, n.getUTCDate()); pick(d); });

          return { open, close };
        }

        const datePicker = buildDatePicker();

        function syncPair(textEl, calEl, todayEl) {
          function setBoth(date) {
            calEl.value = toYMD(date);
            textEl.value = fmtMDY(date);
            setInvalid(textEl, false);
            setInvalid(calEl, false);
          }
          
          textEl.addEventListener('input', () => {
            const p = parseMDY(textEl.value);
            if (!p) { setInvalid(textEl, textEl.value.trim().length > 0); return; }
            const d = toISODateUTC(p.y, p.m, p.d);
            setBoth(d);
            onChange();
          });

          function openPicker(){
            const existing = dateFromInputs(textEl, calEl);
            // Use the input wrapper as anchor if possible, else the input
            const anchor = textEl.parentElement.classList.contains('input-wrapper') ? textEl.parentElement : textEl;
            datePicker.open(anchor, existing, (picked) => {
              if (picked) setBoth(picked); else { textEl.value=''; calEl.value=''; }
              onChange();
            });
          }

          textEl.addEventListener('focus', openPicker);
          textEl.addEventListener('click', openPicker);
          
          calEl.addEventListener('change', () => {
            const v = calEl.value;
            if (!/^\d{4}-\d{2}-\d{2}$/.test(v)) { setInvalid(calEl, true); return; }
            const [y,m,d] = v.split('-').map(Number);
            const date = toISODateUTC(y,m,d);
            setBoth(date);
            onChange();
          });

          todayEl.addEventListener('click', (e) => {
            e.preventDefault();
            const now = new Date();
            const date = toISODateUTC(now.getUTCFullYear(), now.getUTCMonth()+1, now.getUTCDate());
            setBoth(date);
            onChange();
          });
          return { setBoth };
        }

        function dateFromInputs(txtEl, calEl) {
          const p = parseMDY(txtEl.value);
          if (p) return toISODateUTC(p.y, p.m, p.d);
          if (/^\d{4}-\d{2}-\d{2}$/.test(calEl.value)) {
            const [y,m,d] = calEl.value.split('-').map(Number);
            return toISODateUTC(y,m,d);
          }
          return null;
        }

        function diffAbsDays(a,b) {
          const ms = Math.abs(a.getTime() - b.getTime());
          return Math.round(ms / 86400000);
        }

        function calendarDiff(a, b) {
          let start = a, end = b, sign = 1;
          if (a.getTime() > b.getTime()) { start = b; end = a; sign = -1; }
          const sa = fromISODateUTC(start);
          const ea = fromISODateUTC(end);
          let years = ea.y - sa.y;
          let months = ea.m - sa.m;
          let days = ea.d - sa.d;
          if (days < 0) {
            months -= 1;
            const prevMonth = ea.m - 1 <= 0 ? 12 : (ea.m - 1);
            const prevYear = prevMonth === 12 ? ea.y - 1 : ea.y;
            days += daysInMonth(prevYear, prevMonth);
          }
          if (months < 0) { months += 12; years -= 1; }
          return { years: years * sign, months: months * sign, days: days * sign };
        }

        function monthsBetween(start, end) {
          const s = fromISODateUTC(start); const e = fromISODateUTC(end);
          let months = (e.y - s.y) * 12 + (e.m - s.m);
          if (e.d < s.d) months -= 1;
          return months;
        }

        function addCalendar(date, amount, unit) {
          const {y,m,d} = fromISODateUTC(date);
          if (unit === 'days') {
            return new Date(Date.UTC(y, m-1, d + amount));
          } else if (unit === 'weeks') {
            return new Date(Date.UTC(y, m-1, d + amount * 7));
          } else if (unit === 'months') {
            const nm = m - 1 + amount;
            const ny = y + Math.floor(nm / 12);
            const mo = ((nm % 12) + 12) % 12; 
            const maxd = daysInMonth(ny, mo+1);
            const nd = Math.min(d, maxd);
            return new Date(Date.UTC(ny, mo, nd));
          } else if (unit === 'years') {
            const ny = y + amount;
            const maxd = daysInMonth(ny, m);
            const nd = Math.min(d, maxd);
            return new Date(Date.UTC(ny, m-1, nd));
          }
          return date;
        }

        function numberFmt(n) { return n.toLocaleString(); }

        function renderDiff() {
          const out = els.diffResult;
          const a = dateFromInputs(els.diffStartTxt, els.diffStartCal);
          const b = dateFromInputs(els.diffEndTxt, els.diffEndCal);
          if (!a || !b) { out.innerHTML = '<div class="result-empty">Enter both dates to see the difference.</div>'; return; }
          
          const days = diffAbsDays(a,b);
          const weeks = Math.floor(days / 7);
          const remDays = days % 7;
          const cal = calendarDiff(a,b);
          const totalMonths = Math.abs(monthsBetween(a,b));
          
          out.innerHTML = `
            <div class="result-item">
              <div class="result-label">Calendar Difference</div>
              <div class="result-value result-highlight">${Math.abs(cal.years)}y ${Math.abs(cal.months)}m ${Math.abs(cal.days)}d</div>
            </div>
            <div class="result-item">
              <div class="result-label">Total Days</div>
              <div class="result-value">${numberFmt(days)}</div>
            </div>
            <div class="result-item">
              <div class="result-label">Weeks</div>
              <div class="result-value">${numberFmt(weeks)}w ${remDays}d</div>
            </div>
            <div class="result-item">
              <div class="result-label">Total Months</div>
              <div class="result-value">${numberFmt(totalMonths)}</div>
            </div>
          `;
        }

        function renderCalc() {
          const out = els.calcResult;
          const base = dateFromInputs(els.baseTxt, els.baseCal);
          const amt = Number(els.amount.value || '0');
          const unit = els.unit.value;
          const op = els.op.value;
          
          if (!base) { out.innerHTML = '<div class="result-empty">Set base date and amount to see the result.</div>'; return; }
          if (!Number.isFinite(amt)) { out.textContent = 'Amount must be a number.'; return; }
          
          const signed = (op === 'sub') ? -amt : amt;
          const result = addCalendar(base, signed, unit);
          const deltaDays = diffAbsDays(base, result);
          const cal = calendarDiff(base, result);
          
          out.innerHTML = `
            <div class="result-item">
              <div class="result-label">Result Date</div>
              <div class="result-value result-highlight">${fmtMDY(result)}</div>
            </div>
            <div class="result-item">
              <div class="result-label">ISO Date</div>
              <div class="result-value"><code>${toYMD(result)}</code></div>
            </div>
            <div class="result-item">
              <div class="result-label">Change</div>
              <div class="result-value">${Math.abs(cal.years)}y ${Math.abs(cal.months)}m ${Math.abs(cal.days)}d</div>
            </div>
            <div class="result-item">
              <div class="result-label">Total Days Moved</div>
              <div class="result-value">${numberFmt(deltaDays)}</div>
            </div>
          `;
        }

        function onChange(){ renderDiff(); renderCalc(); }

        const diffStart = syncPair(els.diffStartTxt, els.diffStartCal, els.diffStartToday);
        const diffEnd = syncPair(els.diffEndTxt, els.diffEndCal, els.diffEndToday);
        const basePair = syncPair(els.baseTxt, els.baseCal, els.baseToday);

        const now = new Date();
        const todayUTC = toISODateUTC(now.getUTCFullYear(), now.getUTCMonth()+1, now.getUTCDate());
        diffStart.setBoth(todayUTC);
        diffEnd.setBoth(todayUTC);
        basePair.setBoth(todayUTC);

        ['amount','unit','op'].forEach(id => { const e = els[id]; if (e) e.addEventListener('input', onChange); if (e) e.addEventListener('change', onChange); });

	        // Theme toggle lives in the shared header.

        onChange();
      })();
    </script>
  </body>
</html>
