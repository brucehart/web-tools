<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pastebin</title>
    <style>
      :root { color-scheme: light dark; }
      * { box-sizing: border-box; }
      html, body { height: 100%; margin: 0; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, sans-serif; }
      header { display: flex; gap: 8px; align-items: center; justify-content: space-between; padding: .75rem 1rem; border-bottom: 1px solid #ddd; }
      h1 { margin: 0; font-size: 1.15rem; }
      main { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; }
      .panel { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
      .panel header { border-bottom: 1px solid #ddd; padding: .5rem .75rem; }
      .panel .content { padding: .75rem; display: flex; gap: 8px; flex-direction: column; }
      textarea { width: 100%; min-height: 220px; resize: vertical; padding: .75rem; border: 1px solid #ccc; border-radius: 8px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 14px; }
      input, select, button { font: inherit; padding: .5rem .6rem; border-radius: 8px; border: 1px solid #ccc; }
      .row { display: flex; gap: 8px; align-items: center; }
      .grow { flex: 1; }
      .muted { color: #777; font-size: .9rem; }
      .list { padding: .5rem; max-height: 420px; overflow: auto; }
      .list-item { display: flex; justify-content: space-between; align-items: center; padding: .5rem; border-bottom: 1px solid #eee; gap: 8px; }
      .list-item a { text-decoration: none; }
      .pill { font-size: .75rem; border: 1px solid #bbb; border-radius: 999px; padding: .15rem .5rem; }
      .right { margin-left: auto; }
      .btn-danger { background:#d9534f; border-color:#d43f3a; color:white }
      @media (max-width: 1000px) { main { grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <header>
      <h1>Pastebin</h1>
      <div id="authArea" class="row"></div>
    </header>
    <main>
      <section id="viewPanel" class="panel" style="display:none">
        <header><strong>View Paste</strong></header>
        <div class="content">
          <div class="row"><input id="vtitle" class="grow" readonly /></div>
          <textarea id="vcontent" readonly></textarea>
          <div class="row" style="justify-content: space-between; align-items: center;">
            <div class="muted" id="vmeta"></div>
            <button id="deleteBtn" style="display:none; background:#d9534f; border-color:#d43f3a; color:white">Delete</button>
          </div>
          <div class="muted" id="verror" style="display:none"></div>
        </div>
      </section>
      <section class="panel">
        <header><strong>Create Paste</strong></header>
        <div class="content">
          <input id="title" class="grow" placeholder="Title (optional)" />
          <textarea id="content" placeholder="Paste text here..."></textarea>
          <div class="row">
            <label for="visibility">Visibility</label>
            <select id="visibility">
              <option value="public">Public</option>
              <option value="unlisted">Unlisted</option>
            </select>
            <button id="createBtn" class="right">Create</button>
          </div>
          <div id="createResult" class="muted"></div>
        </div>
      </section>
      <section class="panel">
        <header><strong>Your Pastes</strong></header>
        <div class="list" id="mineList"><div class="muted">Sign in to see your pastes.</div></div>
        <header><strong>Recent Public</strong></header>
        <div class="list" id="publicList"><div class="muted">Loading…</div></div>
      </section>
    </main>
    <script>
      const qs = (sel) => document.querySelector(sel);
      async function api(path, opts={}) {
        const res = await fetch(path, Object.assign({credentials:'include'}, opts));
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      }
      function el(tag, attrs={}, children=[]) { const e = document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>{ if(k==='class') e.className=v; else if(k==='href'||k==='target'||k==='rel') e.setAttribute(k,v); else e[k]=v; }); children.forEach(c=> e.appendChild(typeof c==='string'?document.createTextNode(c):c)); return e; }

      async function refreshAuth() {
        try {
          const me = await api('/api/auth/me');
          if (me.loggedIn) {
            qs('#authArea').innerHTML = '';
            qs('#authArea').append(
              el('span', { class: 'muted' }, [me.user.email]),
              el('button', { onclick: async()=>{ await api('/api/auth/logout', { method: 'POST' }); location.reload(); } }, ['Logout'])
            );
            loadMine();
          } else {
            qs('#authArea').innerHTML = '';
            qs('#authArea').append(
              el('a', { href: '/auth/google/login' }, ['Login with Google'])
            );
          }
        } catch (e) {
          console.error(e);
        }
      }

      async function loadMine() {
        try {
          const data = await api('/api/pastebin/mine');
          const list = qs('#mineList');
          list.innerHTML = '';
          if (!data || !data.length) { list.append(el('div', {class:'muted'}, ['No pastes yet.'])); return; }
          data.forEach(p => {
            const row = el('div', { class: 'list-item' }, []);
            const link = el('a', { href: `/pastebin/p/${p.id}` }, [p.title || '(untitled)']);
            const vis = el('span', { class: 'pill' }, [p.visibility]);
            const del = el('button', { class: 'btn-danger', title: 'Delete paste' }, ['Delete']);
            del.addEventListener('click', async (ev) => {
              ev.preventDefault(); ev.stopPropagation();
              if (!confirm('Delete this paste? This cannot be undone.')) return;
              try {
                await api('/api/pastebin/delete', { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify({ id: p.id }) });
                loadMine();
                loadPublic();
                const m = location.pathname.match(/\/pastebin\/p\/([A-Za-z0-9_-]+)/);
                if (m && m[1] === p.id) location.href = '/pastebin';
              } catch (e) {
                alert('Failed to delete paste: ' + e.message);
              }
            });
            row.append(link, vis, del);
            list.append(row);
          });
        } catch (e) {
          qs('#mineList').innerHTML = '<div class="muted">Sign in to see your pastes.</div>';
        }
      }

      async function loadPublic() {
        try {
          const data = await api('/api/pastebin/public');
          const list = qs('#publicList');
          list.innerHTML = '';
          if (!data || !data.length) { list.append(el('div', {class:'muted'}, ['No public pastes.'])); return; }
          data.forEach(p => {
            list.append(el('div', { class: 'list-item' }, [
              el('a', { href: `/pastebin/p/${p.id}` }, [p.title || '(untitled)']),
              el('span', { class: 'pill' }, [new Date(p.created_at).toLocaleString()])
            ]));
          });
        } catch (e) {
          qs('#publicList').innerHTML = '<div class="muted">Failed to load.</div>';
        }
      }

      async function createPaste() {
        const title = qs('#title').value.trim();
        const content = qs('#content').value;
        const visibility = qs('#visibility').value;
        if (!content) { alert('Please enter content'); return; }
        try {
          const res = await api('/api/pastebin/create', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ title, content, visibility })
          });
          const url = `/pastebin/p/${res.id}`;
          qs('#createResult').innerHTML = `Created: <a href="${url}">${url}</a>`;
          loadMine();
          if (visibility === 'public') loadPublic();
        } catch (e) {
          alert('Failed to create paste: ' + e.message);
        }
      }

      qs('#createBtn').addEventListener('click', createPaste);
      async function maybeView() {
        const injected = window.PASTE_ID;
        const m = !injected && location.pathname.match(/\/pastebin\/p\/([^\/?#]+)/);
        const id = injected || (m ? m[1].replace(/\/$/, '') : (new URL(location.href)).searchParams.get('id'));
        if (!id) return;
        try {
          const data = await api(`/api/pastebin/get?id=${encodeURIComponent(id)}`);
          document.title = (data.title || 'Paste') + ' - Pastebin';
          qs('#vtitle').value = data.title || '';
          qs('#vcontent').value = data.content || '';
          qs('#vmeta').textContent = `${data.visibility.toUpperCase()} • ${new Date(data.created_at).toLocaleString()}`;
          qs('#viewPanel').style.display = '';
          // De-emphasize create/list panels when viewing a specific paste
          document.querySelectorAll('main > section.panel').forEach((s, idx) => { if (idx > 0) s.style.opacity = '0.6'; });
          if (data.can_delete) {
            const delBtn = qs('#deleteBtn');
            delBtn.style.display = '';
            delBtn.onclick = async () => {
              if (!confirm('Delete this paste? This cannot be undone.')) return;
              try {
                await api('/api/pastebin/delete', { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify({ id }) });
                location.href = '/pastebin';
              } catch (e) {
                alert('Failed to delete paste: ' + e.message);
              }
            };
          }
          // Scroll to top to show the viewer first
          window.scrollTo({ top: 0 });
        } catch (e) {
          console.error(e);
          qs('#verror').style.display = '';
          qs('#verror').textContent = 'Failed to load paste.';
          qs('#viewPanel').style.display = '';
        }
      }

      refreshAuth();
      loadPublic();
      maybeView();
    </script>
  </body>
  </html>
